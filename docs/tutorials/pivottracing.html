<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Brown Tracing Framework</title>

        <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/bootstrap.min.css">
        <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/font-awesome.min.css">
        <!-- <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/highlight.dark.css"> -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/googlecode.min.css">

        <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/main.css">
        <link href="http://fonts.googleapis.com/css?family=Abel:400|Oswald:300,400,700" media="all" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="http://brownsys.github.io/tracing-framework/docs/images/baggage.png">

    </head>
    <body>

        <header class="navbar navbar-default navbar-fixed-top">

            <div class="navbar-title col-lg-10 col-lg-offset-1">
                <a class="navbar-logo" href="http://brownsys.github.io/tracing-framework/">
                                            <img src="http://brownsys.github.io/tracing-framework/docs/images/baggage.png"></img>
                                    </a>

                <a class="navbar-brand" href="http://brownsys.github.io/tracing-framework/">
                    Brown Tracing Framework
                                    </a>
            </div>

                            <a href="https://github.com/brownsys/tracing-framework">
                    <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png">
                </a>
            
        </header>

        <main class="container-fluid">
            <div class="row">

                
                    <nav id="sidebar" class="col-sm-4 col-lg-3 col-lg-offset-1" role="navigation">

                 <!--       <ul class="nav nav-pills nav-stacked">
                                                    </ul> -->

                        <ul>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/">                        
                                                                        Home
                                                                            </a>
                                    
                                    <ul>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/docs/tutorials.html">                        
                                                                        Tutorials
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/prerequisites.html">
                                                    Pre-requisites
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/gettingstarted.html">
                                                    Getting Started: HDFS
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/pivottracing.html">
                                                    Getting Started: Pivot Tracing
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/baggage.html">
                                                    Adding Baggage To Your System
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/tracingapplication.html">
                                                    Using Baggage Yourself
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/tracingplane">                        
                                                                        Tracing Plane
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/pubsub">
                                                    PubSub
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/client">
                                                    Baggage
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/aspects">
                                                    Auto-Baggage
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/dynamic">
                                                    Dynamic Instrumentation
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/pivottracing">                        
                                                                        Pivot Tracing
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/client">
                                                    Client
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pivottracing/tracepoints.html">
                                                    Client: Tracepoints
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pivottracing/queries.html">
                                                    Client: Writing Queries
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pivottracing/installing.html">
                                                    Client: Installing Queries
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/agent">
                                                    Agent
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/privileged">
                                                    Agent: Privileged Classes
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/test">
                                                    Examples
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/xtrace">                        
                                                                        X-Trace
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/client">
                                                    Client Library
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/aspects">
                                                    Automatic Instrumentation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/server">
                                                    Report Server
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/visualization">
                                                    Visualization
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                    Retro
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/resources">
                                                    Resource Instrumentation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/aspects">
                                                    Auto-Instrumentation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/aggregation">
                                                    Aggregation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/throttling">
                                                    Tenant Throttling
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/visualization">
                                                    Visualization
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/retro/configuration.html">
                                                    Configuration
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/retro/retrowithxtrace.html">
                                                    Retro + X-Trace
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/retro/lockinstrumentation.html">
                                                    Instrumentation for Locks
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                    Reference
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/config.html">
                                                    Configuration
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tools.html">
                                                    Tools and Executables
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pom.html">
                                                    Example pom.xml
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                    </ul>


                    </nav>

                

                <section id="content" class="col-sm-8 col-lg-6">
                    <h1 id="getting-started-pivot-tracing">Getting Started: Pivot Tracing</h1>
<p>Once HDFS is up and running, we can dynamically install some Pivot Tracing queries.  The <code>pivottracing/client</code> project provides some simple command line utilities that we will use.  The executables will be located in the <code>target/appassembler/bin</code> folder.  First, open up a terminal and run the <code>print-agent-status</code> executable.</p>
<pre><code>target/appassembler/bin/print-agent-status</code></pre>
<p>This will ping all connected Pivot Tracing agents every 10 seconds and ask them for their current status.   You should see something like the following as output:</p>
<pre><code>agent {
  procName: "NameNode"
  procId: 7831
  host: "localhost"
}
dynamicInstrumentationEnabled: true

agent {
  procName: "DataNode"
  procId: 7873
  host: "localhost"
}
dynamicInstrumentationEnabled: true</code></pre>
<p>Now we will install an example query.  We are going to install the following Pivot Tracing query:</p>
<pre><code>From incr In DataNodeMetrics.incrBytesRead
Join getloc In NN.GetBlockLocations On getloc -&gt; incr
GroupBy incr.host, getloc.src
Select incr.host, getloc.src, SUM(incr.delta)</code></pre>
<p>This query counts bytes read on HDFS DataNodes, and attributes them to source files.  Specifically, when a request passes through the GetBlockLocations method on the NameNode, Pivot Tracing will save the value of the <code>src</code> variable; then later, when the request passes through the <code>incrBytesRead</code> method on the DataNode, Pivot Tracing will associate the value of the <code>delta</code> variable with the previous <code>src</code> from the NameNode.</p>
<p>We will install this query by running the <code>example-hdfs-query</code> executable.</p>
<pre><code>target/appassembler/bin/example-hdfs-query</code></pre>
<p>This will compile an query into instrumentation and publish to the Pivot Tracing agents.  They will dynamically modify some Java classes, reload them, and start outputting query results.  The example-hdfs-query executable will produce output like the following:</p>
<pre><code>Query: 

From incr In DataNodeMetrics.incrBytesRead
Join getloc In NN.GetBlockLocations On getloc -&gt; incr
GroupBy incr.host, getloc.src
Select incr.host, getloc.src, SUM(incr.delta)

============================================================
Compiled query:

QGETLOC = From NN.GetBlockLocations

From incr In DataNodeMetrics.incrBytesRead
Join getloc In QGETLOC On getloc -&gt; incr
GroupBy incr.host, getloc.src
Select incr.host, getloc.src, SUM(incr.delta)

============================================================
Optimized query:

QGETLOC = From NN.GetBlockLocations
GroupBy src
Select src

From incr In DataNodeMetrics.incrBytesRead
Join getloc In QGETLOC On getloc -&gt; incr
GroupBy incr.host, getloc.src
Select incr.host, getloc.src, SUM(incr.delta)

============================================================
Query advice:

A0 at NN.GetBlockLocations
OBSERVE 0.src
PACK BAG-0-0 0.src, 

A1 at DataNodeMetrics.incrBytesRead
OBSERVE 0.host, 1.delta
UNPACK BAG-0-0 2.src, 
EMIT Q-0 0.host, 2.src, SUM(1.delta)

============================================================
2016-03-03 14:21:08 INFO  PivotTracingClient:121 - Publishing command to PTcommands:
update {
  weave {
    id: "\000\001\000\000"
    advice {
      observe {
        var: "0.src"
      }
      pack {
        bagId: "\000\001\000\000"
        groupBySpec {
          groupBy: "0.src"
        }
      }
    }
    tracepoint {
      methodTracepoint {
        className: "org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer"
        methodName: "getBlockLocations"
        paramClass: "java.lang.String"
        paramClass: "long"
        paramClass: "long"
        where: RETURN
        adviceArg {
          literal: "src"
        }
      }
    }
  }
  weave {
    id: "\000\001\000\001"
    advice {
      observe {
        var: "0.host"
        var: "1.delta"
      }
      unpack {
        bagId: "\000\001\000\000"
        groupBySpec {
          groupBy: "2.src"
        }
      }
      emit {
        outputId: "\000\001"
        groupBySpec {
          groupBy: "0.host"
          groupBy: "2.src"
          aggregate {
            name: "1.delta"
            how: SUM
          }
        }
      }
    }
    tracepoint {
      methodTracepoint {
        className: "org.apache.hadoop.hdfs.server.datanode.metrics.DataNodeMetrics"
        methodName: "incrBytesRead"
        paramClass: "int"
        where: ENTRY
        adviceArg {
          literal: "edu.brown.cs.systems.tracing.Utils.getHost()"
        }
        adviceArg {
          literal: "new Integer(delta)"
        }
      }
    }
  }
}

2016-03-03 14:21:08 INFO  PubSubClient:259 - Attempting connection to 127.0.0.1:5563 with 0 pending messages
Query sent to agents</code></pre>
<p>In the terminal where you ran the <code>print-agent-status</code> executable, you will now see messages like the following:</p>
<pre><code>agent {
  procName: "DataNode"
  procId: 8448
  host: "localhost"
}
dynamicInstrumentationEnabled: true
woven {
  id: "\000\001\000\000"
  advice {
    observe {
      var: "0.src"
    }
    pack {
      bagId: "\000\001\000\000"
      groupBySpec {
        groupBy: "0.src"
      }
    }
  }
  tracepoint {
    methodTracepoint {
      className: "org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer"
      methodName: "getBlockLocations"
      paramClass: "java.lang.String"
      paramClass: "long"
      paramClass: "long"
      where: RETURN
      adviceArg {
        literal: "src"
      }
    }
  }
}
woven {
  id: "\000\001\000\001"
  advice {
    observe {
      var: "0.host"
      var: "1.delta"
    }
    unpack {
      bagId: "\000\001\000\000"
      groupBySpec {
        groupBy: "2.src"
      }
    }
    emit {
      outputId: "\000\001"
      groupBySpec {
        groupBy: "0.host"
        groupBy: "2.src"
        aggregate {
          name: "1.delta"
          how: SUM
        }
      }
    }
  }
  tracepoint {
    methodTracepoint {
      className: "org.apache.hadoop.hdfs.server.datanode.metrics.DataNodeMetrics"
      methodName: "incrBytesRead"
      paramClass: "int"
      where: ENTRY
      adviceArg {
        literal: "edu.brown.cs.systems.tracing.Utils.getHost()"
      }
      adviceArg {
        literal: "new Integer(delta)"
      }
    }
  }
}</code></pre>
<p>If any exceptions occurred in attempting to install the instrumentation, they will be included in the message here.  They will also show up in the HDFS output logs.  The following is an example error message (from a different query):</p>
<pre><code>problem {
  name: "javassist.NotFoundException"
  message: "edu.brown.cs.systems.hdfsworkloadgenerator.Client"
  stacktrace: "javassist.NotFoundException: edu.brown.cs.systems.hdfsworkloadgenerator.Client\n\tat javassist.ClassPool.get(ClassPool.java:450)\n\tat edu.brown.cs.systems.pivottracing.dynamicinstrumentation.MethodRewriteModification.getMethod(MethodRewriteModification.java:62)\n\tat edu.brown.cs.systems.pivottracing.dynamicinstrumentation.MethodRewriteModification.getMethod(MethodRewriteModification.java:56)\n\tat edu.brown.cs.systems.pivottracing.dynamicinstrumentation.MethodRewriteModification.apply(MethodRewriteModification.java:43)\n\tat edu.brown.cs.systems.dynamicinstrumentation.Agent$Installation.modify(Agent.java:126)\n\tat edu.brown.cs.systems.dynamicinstrumentation.Agent$Installation.modifyAll(Agent.java:139)\n\tat edu.brown.cs.systems.dynamicinstrumentation.Agent.install(Agent.java:78)\n\tat edu.brown.cs.systems.dynamicinstrumentation.DynamicManager.install(DynamicManager.java:77)\n\tat edu.brown.cs.systems.pivottracing.agent.WeaveManager.install(WeaveManager.java:74)\n\tat edu.brown.cs.systems.pivottracing.agent.PTAgent.install(PTAgent.java:101)\n\tat edu.brown.cs.systems.pivottracing.agent.PTAgent$PubSubCommandSubscriber.OnMessage(PTAgent.java:141)\n\tat edu.brown.cs.systems.pivottracing.agent.PTAgent$PubSubCommandSubscriber.OnMessage(PTAgent.java:134)\n\tat edu.brown.cs.systems.pubsub.PubSubClient$Subscriber.OnMessage(PubSubClient.java:343)\n\tat edu.brown.cs.systems.pubsub.PubSubClient.OnMessage(PubSubClient.java:130)\n\tat edu.brown.cs.systems.pubsub.PubSubClient.access$000(PubSubClient.java:34)\n\tat edu.brown.cs.systems.pubsub.PubSubClient$ClientReader.OnMessage(PubSubClient.java:146)\n\tat edu.brown.cs.systems.pubsub.io.TopicReader.OnMessage(TopicReader.java:28)\n\tat edu.brown.cs.systems.pubsub.io.MessageReader.read(MessageReader.java:76)\n\tat edu.brown.cs.systems.pubsub.PubSubClient.ClientThreadMainLoop(PubSubClient.java:243)\n\tat edu.brown.cs.systems.pubsub.PubSubClient.ClientThreadRun(PubSubClient.java:264)\n\tat edu.brown.cs.systems.pubsub.PubSubClient.run(PubSubClient.java:285)\n"
}</code></pre>
<p>Also, if necessary, you can uninstall queries using the <code>uninstall-all-queries</code> executable.  For now, the <code>example-hdfs-query</code> executable should successfully install.</p>
<p>We will now run some HDFS requests and observe the query results.
In a new terminal, run the <code>print-query-results</code> utility.</p>
<pre><code>target/appassembler/bin/print-query-results</code></pre>
<p>This will subscribe to the query results topic and print any query results sent by any Pivot Tracing agent.  Since HDFS is currently idle, you will only see the following::</p>
<pre><code>2016-03-03 13:51:09 INFO  PubSubClient:110 - Subscribing topic PTresults
2016-03-03 13:51:09 INFO  PubSubClient:259 - Attempting connection to 127.0.0.1:5563 with 0 pending messages
2016-03-03 13:51:09 INFO  PubSubClient:182 - Sending existing subscriptions</code></pre>
<p>Now we will use the HDFS command line utility to copy a file into HDFS then read it out of HDFS.  The HDFS command line utility, <code>hdfs</code>, will be located in <code>hadoop-dist/target/hadoop-2.7.2/bin</code> inside the Hadoop git repository.  Run the following command:</p>
<pre><code>echo "Hello World" &gt;&gt; example.txt
hdfs dfs -copyFromLocal example.txt /example.txt
hdfs dfs -copyToLocal /example.txt example2.txt</code></pre>
<p>This will create a file containing the text &quot;Hello World&quot;, copy it into HDFS, then copy it out of HDFS.  The print-query-results executable will print something like the following:</p>
<pre><code>emit {
  outputId: "\000\001"
  groupBySpec {
    groupBy: "0.host"
    groupBy: "2.src"
    aggregate {
      name: "1.delta"
      how: SUM
    }
  }
}
agent {
  procName: "DataNode"
  procId: 8448
  host: "localhost"
}
timestamp: 1457033092668
group {
  groupBy: "localhost"
  groupBy: "/example.txt"
  aggregation: 16
}</code></pre>
                </section>

            </div>
        </main>

        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <!-- <script src="//yastatic.net/highlightjs/8.2/highlight.min.js"></script> -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>


        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');
                // Syntax highlighting
                hljs.initHighlightingOnLoad();
            });
        </script>

    </body>
</html>
