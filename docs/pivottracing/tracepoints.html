<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Brown Tracing Framework</title>

        <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/bootstrap.min.css">
        <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/font-awesome.min.css">
        <!-- <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/highlight.dark.css"> -->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/googlecode.min.css">

        <link rel="stylesheet" href="http://brownsys.github.io/tracing-framework/css/main.css">
        <link href="http://fonts.googleapis.com/css?family=Abel:400|Oswald:300,400,700" media="all" rel="stylesheet" type="text/css">
    </head>
    <body>

        <header class="navbar navbar-default navbar-fixed-top">

            <div class="navbar-title col-lg-10 col-lg-offset-1">
                <a class="navbar-logo" href="http://brownsys.github.io/tracing-framework/">
                                            <img src="http://brownsys.github.io/tracing-framework/docs/images/baggage.png"></img>
                                    </a>

                <a class="navbar-brand" href="http://brownsys.github.io/tracing-framework/">
                    Brown Tracing Framework
                                    </a>
            </div>

                            <a href="https://github.com/brownsys/tracing-framework">
                    <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png">
                </a>
            
        </header>

        <main class="container-fluid">
            <div class="row">

                
                    <nav id="sidebar" class="col-sm-4 col-lg-3 col-lg-offset-1" role="navigation">

                 <!--       <ul class="nav nav-pills nav-stacked">
                                                    </ul> -->

                        <ul>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/">                        
                                                                        Home
                                                                            </a>
                                    
                                    <ul>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/docs/tutorials.html">                        
                                                                        Tutorials
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/prerequisites.html">
                                                    Pre-requisites
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/gettingstarted.html">
                                                    Getting Started: HDFS
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/pivottracing.html">
                                                    Getting Started: Pivot Tracing
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/baggage.html">
                                                    Adding Baggage To Your System
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tutorials/tracingapplication.html">
                                                    Using Baggage Yourself
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/tracingplane">                        
                                                                        Tracing Plane
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/pubsub">
                                                    PubSub
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/client">
                                                    Baggage
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/aspects">
                                                    Auto-Baggage
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/tracingplane/dynamic">
                                                    Dynamic Instrumentation
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/pivottracing">                        
                                                                        Pivot Tracing
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/client">
                                                    Client
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pivottracing/tracepoints.html">
                                                    Client: Tracepoints
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pivottracing/queries.html">
                                                    Client: Writing Queries
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pivottracing/installing.html">
                                                    Client: Installing Queries
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/agent">
                                                    Agent
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/privileged">
                                                    Agent: Privileged Classes
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/pivottracing/test">
                                                    Examples
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                        <a class="sectionlink" href="http://brownsys.github.io/tracing-framework/xtrace">                        
                                                                        X-Trace
                                                                            </a>
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/client">
                                                    Client Library
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/aspects">
                                                    Automatic Instrumentation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/server">
                                                    Report Server
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/xtrace/visualization">
                                                    Visualization
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                    Retro
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/resources">
                                                    Resource Instrumentation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/aspects">
                                                    Auto-Instrumentation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/aggregation">
                                                    Aggregation
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/throttling">
                                                    Tenant Throttling
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/retro/visualization">
                                                    Visualization
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/retro/configuration.html">
                                                    Configuration
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/retro/retrowithxtrace.html">
                                                    Retro + X-Trace
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/retro/lockinstrumentation.html">
                                                    Instrumentation for Locks
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                            <li>
                            		                                    Reference
                                    
                                    <ul>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/config.html">
                                                    Configuration
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/tools.html">
                                                    Tools and Executables
                                                </a>
                                            </li>
                                                                                    <li class="">
                                                <a class="pagelink" href="http://brownsys.github.io/tracing-framework/docs/pom.html">
                                                    Example pom.xml
                                                </a>
                                            </li>
                                                                            </ul>
                                </li>
                                                    </ul>


                    </nav>

                

                <section id="content" class="col-sm-8 col-lg-6">
                    <h2 id="pivot-tracing-client-tracepoints">Pivot Tracing Client: Tracepoints</h2>
<p>Tracepoints typically correspond to method invocations, and can be uniquely identified by their method signature.  For example, the <code>DataNodeMetrics.incrBytesRead</code> tracepoint specifically refers to the method:</p>
<pre><code>void org.apache.hadoop.hdfs.server.datanode.metrics.DataNodeMetrics.incrBytesRead(int delta)</code></pre>
<p>The <code>MethodTracepoint</code> class represents such a tracepoint.  To create a tracepoint for this method, we can invoke the static API:</p>
<pre><code>MethodTracepoint hdfs_datanode_incrBytesRead = Tracepoints.method( "org.apache.hadoop.hdfs.server.datanode.metrics.DataNodeMetrics", "incrBytesRead", "int" );</code></pre>
<p>This is shorthand for the following:</p>
<pre><code>MethodTracepoint hdfs_datanode_incrBytesRead = new MethodTracepoint(
    "DataNodeMetrics.incrBytesRead",                                  // name for the tracepoint
    Where.ENTRY,                                                      // where in the method
    "org.apache.hadoop.hdfs.server.datanode.metrics.DataNodeMetrics", // class name
    "incrBytesRead",                                                  // method name
    "int"                                                             // method parameter types
);</code></pre>
<h4 id="exporting-variables">Exporting variables</h4>
<p>Suppose we want to write a query that refers to the <code>delta</code> parameter of <code>incrBytesRead</code>.  When defining a tracepoint, we must explicitly export any variables that we want to use in a query like this.  To do this, we call the <code>addExport</code> method:</p>
<pre><code>hdfs_datanode_incrBytesRead.addExport("delta", "delta");</code></pre>
<p>This defines a <em>query variable</em> called <code>delta</code>, whose value is derived from the <em>Java literal</em> delta.  </p>
<h4 id="default-exports">Default exports</h4>
<p>Tracepoints export some variables by default, such as hostname, timestamp, etc.  They are equivalent to the following:</p>
<pre><code>hdfs_datanode_incrBytesRead.addExport( "host",       "edu.brown.cs.systems.tracing.Utils.getHost()"        );
hdfs_datanode_incrBytesRead.addExport( "timestamp",  "System.currentTimeMillis()"                          );
hdfs_datanode_incrBytesRead.addExport( "cpu",        "edu.brown.cs.systems.clockcycles.CPUCycles.get()"    );
hdfs_datanode_incrBytesRead.addExport( "threadId",   "Thread.currentThread().getId()"                      );
hdfs_datanode_incrBytesRead.addExport( "procId",     "edu.brown.cs.systems.tracing.Utils.getProcessID()"   );
hdfs_datanode_incrBytesRead.addExport( "procName",   "edu.brown.cs.systems.tracing.Utils.getProcessName()" );</code></pre>
<p><em>(Be aware that this is research code, and we don't sanitize these Java literals, so as-is this is a serious security vulnerability)</em></p>
<h4 id="special-variables">Special Variables</h4>
<p>In addition the following Java literals can be used when adding a tracepoint export</p>
<ul>
<li><code>$0</code> takes the value of <code>this</code></li>
<li><code>$1, $2, $3, ...</code> take the values of the corresponding method arguments (and of course, they can also be referenced by name)</li>
<li><code>$_</code> takes the method return value if the tracepoint uses <code>Where.RETURN</code>.</li>
</ul>
<p>See <a href="http://jboss-javassist.github.io/javassist/tutorial/tutorial2.html">this</a> Javassist tutorial for more information on available variables.</p>
<h4 id="arrays-and-collections">Arrays and Collections</h4>
<p>Pivot Tracing also provides handling for array and Collection variables.  For example, suppose we have the following class:</p>
<pre><code>class Users {
    Collection&lt;String&gt; activeUsers = Lists.newArrayList("Jon", "Jeff", "George");
    public void ping() {
    }
}</code></pre>
<p>Suppose <code>ping()</code> is called at a regular interval, and <code>activeUsers</code> is changing, and we want a query that keeps track of how often each user is in active users.  Consider the following query:</p>
<pre><code>FROM ping in Example.Ping
GROUPBY ping.activeUser
SELECT ping.activeUser, COUNT</code></pre>
<p>Conceptually, each time <code>ping()</code> is invoked, we want to treat the invocation as multiple tuples, one tuple for each activeUser in the activeUsers collection.  Pivot Tracing tracepoints provice multi-exports to support collections and arrays:</p>
<pre><code>MethodTracepoint example_ping = Tracepoints.method("Users", "ping");
example_ping.addMultiExport("activeUser", "activeUsers", "String");</code></pre>
<p>Pivot Tracing will interpret the <code>activeUsers</code> variable as a collection or array, and pass each element to the configured query individually.</p>
<h4 id="hardcoded-tracepoints">Hardcoded Tracepoints</h4>
<p>Some systems can hard-code tracepoints, rather than relying on dynamic instrumentation.  A hardcoded tracepoint has a unique ID, and exports zero or more variables.  The following call will get a hardcoded tracepoint called &quot;myMethod_entry&quot;.</p>
<pre><code>Tracepoint t = HardcodedTracepoint.get("myMethod_entry", "a", "b");</code></pre>
<p>See <a href="../../pivottracing/agent">Pivot Tracing Agent</a> for more details on hardcoded tracepoints.</p>
                </section>

            </div>
        </main>

        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <!-- <script src="//yastatic.net/highlightjs/8.2/highlight.min.js"></script> -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>


        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');
                // Syntax highlighting
                hljs.initHighlightingOnLoad();
            });
        </script>

    </body>
</html>
